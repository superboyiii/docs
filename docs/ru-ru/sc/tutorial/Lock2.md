# Инструкция по Lock-контракту

Lock-контракт устанавливает определенную временную метку, то есть до наступления времени, указанного в ней, никто не имеет право выводить активы из контракта. По истечении указанного времени владельцы контракта могут вывести данные активы. 

Текущее время, полученное контрактом, - это время нового блока в блокчейне (погрешность составляет около 15 секунд). Подробнее см. [Blockchain class](../reference/fw/dotnet/neo/Blockchain.md), [Header class](../reference/fw/dotnet/neo/Header.md).

В данном разделе описывается, как развертывать Lock-контракт в блокчейне таким образом, чтобы его могли вызывать другие.

Данный тьюториал создан на базе демоверсии Smart Contract 2.7.4, поэтому вам нужно скачать последнюю версию клиента [Neo GUI ](https://github.com/neo-project/neo-gui/releases) с GitHub и запустить [test net](../../network/testnet.md).

## Создание кошелька 

В NEO-GUI щелкните кнопкой мыши по  `Wallet` -> `New Wallet Database ` чтобы создать кошелек.

![](../../../assets/lock2_1.png)

## Получение открытого ключа

Только что созданный кошелек автоматически создает стандартный счет. Щелкните правой кнопкой мыши по счету, просмотрите закрытый ключ и скопируйте открытый ключ из второй строки, как показано на рисунке:

![](../../../assets/lock2_2.png)

Далее представлена локальная программа для преобразования открытого ключа в байтовый массив (см. ниже):

```c#
namespace ConsoleApp1
{
    class Program
    {
        static void Main(string[] args)
        {
            // Replace the string with the public key copied in the last step
            byte[] b = HexToBytes("0285eab65f4a0126e4b85b4e5d8b7e303aff7efb360d595f2e3189bb90487ad5aa");
            foreach (var item in b)
            {
                Console.Write($"{item}, ");
            }
            Console.ReadLine();
        }

        static byte[] HexToBytes(string hexString)
        {
            hexString = hexString.Trim();
            byte[] returnBytes = new byte[hexString.Length / 2];
            for (int i = 0; i < returnBytes.Length; i++)
            {
                returnBytes[i] = Convert.ToByte(hexString.Substring(i * 2, 2), 16);
            }
            return returnBytes;
        }
    }
}
```

После запуска данной программы на экране отобразится байтовый массив, созданный из открытого ключа. Скопируйте массив, поскольку мы будем использовать его позже.

## Написание смарт-контракта

Создайте проект смарт-контракта и напишите следующий смарт-контракт.

```c#
using Neo.SmartContract.Framework;
using Neo.SmartContract.Framework.Services.Neo;

namespace Neo.SmartContract
{
    public class Lock : SmartContract
    {
        public static bool Main(byte[] signature)
        {
            Header header = Blockchain.GetHeader(Blockchain.GetHeight());
            if (header.Timestamp < 1499328600) // 2017-6-6 18:10
                return false;
            // Paste the public key byte array here
            return VerifySignature(signature，new byte[] { 2, 133, 234, 182, 95, 74, 1, 38, 228, 184, 91, 78, 93, 139, 126, 48, 58, 255, 126, 251, 54, 13, 89, 95, 46, 49, 137, 187, 144, 72, 122, 213, 170 });
        }
    }
}
```

Вам нужно изменить две переменные в коде: открытый ключ (public key) и время блокировки (lock time).

- (public key) открытый ключ: Вставьте предыдущую копию байтового массива открытого ключа.

- (lock time) время блокировки: Измените время блокировки (то есть временную метку Unix) в примере кода. Вы можете высчитать его сами или использовать он-лайн инструмент [Unix timestamp online conversion](https://unixtime.51240.com/).

После замены двух переменных скомпилируйте контракт в файл Lock.avm.

## Получение скрипта контракта

Для получения скрипта контракта вы можете воспользоваться одним из следующих вариантов:

- Используйте код C# (см. ниже), чтобы прочитать файл .avm и получить байт-код.


```c#
byte[] bytes = System.IO.File.ReadAllBytes("Test.avm");
for (int i = 0; i < bytes.Length; i++)
    Console.Write(bytes[i].ToString("x2"));
```

- Используйте NEO-GUI для получения скрипта:
  1. Щелкните кнопкой мыши по `Advanced`-> `Deploy Contract`.
  2. Щелкните кнопкой мыши по кнопке `Load` в нижнем правом углу. Выберите файл `Lock.avm`, сгенерированный ранее.
  3. Скопируйте скрипт контракта из `Code`, как показано ниже

![](../../../assets/lock2_5.png)

## Создание адреса контракта 

1. Щелкните правой кнопкой мыши по области адреса и выберите `Create Contract Add` -> `Custom` , чтобы создать адрес контракта со скриптом контракта, сгенерированным ранее.
2. В окне Import Custom Contract укажите следующее:
   1. Parameter List: поскольку наш контракт имеет параметр для подписи, вы должны ввести `00`. Более подробно см. в [Parameter](../Parameter.md).
   2. Script: введите скрипт контракта, скопированный в предыдущем шаге.
   3. Private Key: Опционально. Если контракт необходимо подписать, укажите закрытый ключ, требующийся для подписания.
3. Щелкните по `OK`. Счет верификации смарт-контракта успешно создан.

![](../../../assets/lock2_8.png)

## Тестирование

Далее представлено тестирование счета верификации смарт-контракта. Способ тестирования выглядит следующим образом: необходимо сначала перевести какие-либо активы на счет аутентификации контракта, а затем вывести их со счета.

> [! Note]
> Чтобы обеспечить точность тестирования, не располагайте никакие другие активы в своем кошельке. В противном случае вы не сможете узнать, с  какого счета был переведен данный актив (со стандартного или с контрактного счета), пока не поймете алгоритм поиска изменений клиента и не узнаете, какая транзакция переведена с адреса смарт-контракта.

### Переведите активы в адрес контракта

Откройте кошелек с активами в **testnet** и переведите определенное количество активов на счет контракта.

### Выведите активы из адреса контракта 

Переведите активы со счета вашего смарт-контракта:

![Transfer contract amount](../../../assets/lock2_11.png)

### Заключение

Если операция, указанная выше, верна, то при переводе актива произойдет следующее:

Когда текущее время будет меньше времени блокировки, перевод не подтвердится, т.е. не совершится.

После нажатия кнопки Rebuild Index в течение 5 минут не подтвержденный перевод исчезнет, ​​а активы вернутся в прежнее состояние.

Если текущее время больше времени блокировки, перевод будет проведен успешно.
