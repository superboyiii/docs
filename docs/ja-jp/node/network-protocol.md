# ネットワークプロトコル


NEOはP2Pネットワーク構造を採用しており、そこでノードはTCP/IPプロトコルを通じて互いに通信することができます。この構造において、2つの異なるタイプのノードがあります:ピアノードとバリデーティングノードです(NEOホワイトペーパーのブックキーパーを参照)。ピアノードはブロードキャストができ、トランザクション又はブロックを送受信できます。一方、バリデーティングノードはブロックを生成できます。


NEOのネットワークプロトコルは、おおよそビットコインのものと同様ですが、ブロック又はトランザクションのようなデータ構造は大きく異なります。

慣例
----

1. バイトオーダー

   IPアドレスとポート番号の2つはビッグエンディアンで、それ以外のすべてのNEOのinteger型はリトルエンディアンです。

1. ハッシュ

   NEOにおける異なる2つのハッシュ機能では、SHA256とRIPEMD160を使用します。SHA256は長いハッシュ値の生成に使用し、RIPEMD160は短いハッシュ値を生成するのに使用します。一般に、ハッシュ機能を2回使用してオブジェクトのハッシュ値を取得します。例えば、ブロック又はトランザクションのハッシュ値を生成したい場合、SHA256機能を2回使用します。コントラクトアドレスを生成する際は、SHA256機能を最初に使用してからRPEMD160を使用します。

   加えて、ブロックはマークル木と呼ばれるハッシュ構造を使用します。それは各トランザクションのハッシュを計算し、他と結合してハッシュを求めるということを、たった1つのルートハッシュ（マークルルート）まで繰り返します。

1. 可変長の型

   + Variant: 可変長の整数は、入力された値に従ってスペースを節約するためにエンコードされます。

      |値|長さ|フォーマット|
      |---|---|---|
      |< 0xfd|1|uint8|
      |<= 0xffff|3|0xfd + uint16|
      |<= 0xffffffff|5|0xfe + uint32|
      |> 0xffffffff|9|0xff + uint64|

   + Varstr: 可変長の文字列で、可変長の整数とそれに続く文字列で構成されます。文字列はUTF8でエンコードされます。

      |サイズ|フィールド|データの型|説明|
      |---|---|---|---|
      |?|length|variant|バイト単位の文字列の長さ|
      |length|string|uint8[length]|文字列そのもの|

   + Array: 配列は可変長の整数とそれに続く一連の要素で構成します。

1. 固定少数点数

   NEOにおける合計や価格のようなデータは64ビット固定小数点数であり、少数部の精度は10<sup>-8</sup>です。範囲: [-2<sup>63</sup>/10<sup>8</sup>, +2<sup>63</sup>/10<sup>8</sup>)

データの型
-------

1. ブロックチェイン

   ブロックチェインは一種の論理構造で、片方向リストで順次接続されています。トランザクションやアセットのようなネットワーク全体のデータを保管するのに使用します。

1. ブロック

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |4|Version|uint32|ブロックのバージョンで、現在は0|
   |32|PrevBlock|uint256|前のブロックのハッシュ値|
   |32|MerkleRoot|uint256|トランザクションリストのルートハッシュ|
   |4|Timestamp|uint32|タイムスタンプ|
   |4|Height|uint32|ブロックの高さ|
   |8|Nonce|uint64|乱数|
   |20|NextMiner|uint160|次のマイナーのコントラクトアドレス|
   |1|-|uint8|1固定|
   |?|Script|script|ブロック検証に使用するスクリプト|
   |?*?|Transactions|tx[]|トランザクションリスト|

   ブロックのハッシュ値を計算する際、ブロック全体を計算する代わりに、ブロックヘッドの最初の7つのフィールドのみ計算されます。それはVersion、PrevBlock、MerkleRoot、Timestamp、Height、Nonceです。MarkleRootは、すでに全てのトランザクションのハッシュ値を含んでいるため、トランザクションの変更は、ブロックのハッシュ値に影響します。

   ブロックヘッドのデータ構造:

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |4|Version|uint32|ブロックのバージョンで、現在は0|
   |32|PrevBlock|uint256|前のブロックのハッシュ値|
   |32|MerkleRoot|uint256|トランザクションリストのルートハッシュ|
   |4|Timestamp|uint32|タイムスタンプ|
   |4|Height|uint32|ブロックの高さ|
   |8|Nonce|uint64|乱数|
   |20|NextMiner|uint160|次のマイナーのコントラクトアドレス|
   |1|-|uint8|1固定|
   |?|Script|script|ブロック検証に使用するスクリプト|
   |1|-|uint8|0固定|

   各ブロックのタイムスタンプは、前のブロックのタイムスタンプより遅れたものでなければなりません。一般に、異なる2つのブロックのタイムスタンプの差は約15秒であり、不正確さが許容されています。ブロックの高さは、前のブロックの高さ+1に正確に等しくならなければなりません。

1. トランザクション

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |1|Type|uint8|トランザクションのタイプ|
   |1|Version|uint8|トレーディングバージョンで、現在は0|
   |?|-|-|トランザクションタイプに固有のデータ|
   |?*?|Attributes|tx_attr[]|トランザクションが持つ追加機能|
   |34*?|Inputs|tx_in[]|インプット|
   |60*?|Outputs|tx_out[]|アウトプット|
   |?*?|Scripts|script[]|トランザクションを検証するのに使われるスクリプトのリスト|

   NEOシステムにおけるすべてのプロセスは、トランザクションとして記録されます。複数のトランザクションのタイプがあります。

   |値|名前|システム Fee|説明|
   |---|---|---|---|
   |0x00|MinerTransaction|0|バイトfeeの割り当て|
   |0x01|IssueTransaction|500\|0|アセットの分配|
   |0x02|ClaimTransaction|0|GASの割り当て|
   |0x20|EnrollmentTransaction|1000|バリデーターへの登録|
   |0x40|RegisterTransaction|10000|アセットの登録|
   |0x80|ContractTransaction|0|コントラクトトランザクション|
   |0xd0|PublishTransaction|500 * n|(使用不可)スマートコントラクトのための特別なトランザクション|
   |0xd1|InvocationTransaction|0|スマートコントラクトを呼び出すための特別なトランザクション|

   各トランザクションのタイプは、パブリックフィールドに加え、独自の排他的フィールドがあります。次に、排他的フィードについて詳細に説明します。

   + MinerTransaction

      |サイズ|フィールド|データの型|説明|
      |---|---|---|---|
      |4|Nonce|uint32|乱数|

   各ブロックの最初のトランザクションはMinerTransactionでなければなりません。現在のブロックにおけるすべてのトランザクションの手数料を、バリデータへの報酬に使用するためです。

   トランザクション内の乱数はハッシュの衝突を回避するのに使用します。

   + IssueTransaction

   トランザクション発行のための特別なフィールドはありません。

   アセットマネージャはIssueTransactionを通じて、NEOのブロックチェーン内に登録されるアセットを作成し、任意のアドレスに送信することができます。

   特に、発行されているアセットがNEOの場合、トランザクションは無料で送信されます。

   トランザクション内の乱数を使用してハッシュの衝突を回避します。

   + ClaimTransaction

      |サイズ|フィールド|データの型|説明|
      |---|---|---|---|
      |34*?|Claims|tx_in[]|配布用のNEO|

   + EnrollmentTransaction

      |サイズ|フィールド|データの型|説明|
      |---|---|---|---|
      |33|PublicKey|ec_point|バリデータのパブリックキー|

   このトランザクションは登録フォームを表し、トランザクションのスポンサーがバリデータとして登録したいことを示します。

   登録の方法は: EnrollmentTransactionタイプのトランザクションを構築し、パブリックキーのアドレスにデポジットを送信します。

   登録キャンセルの方法は: パブリックキーのアドレス上のデポジットを消費します。

   + RegisterTransaction

      > [!警告]
      スマートコントラクトのため、無効化され、Neo.Asset.Createに置き換えられました。

      [Alternative .NET Smart Contract Framework](../sc/fw/dotnet/neo/Asset/Create.md)を参照してください。

      [Alternative Smart Contract API](../sc/api/neo.md)を参照してください。

   + ContractTransaction

   コントラクトトランザクションのための特別な属性はありません。あるウォレットから別のウォレットにNEOを送信できることから、これは非常に一般的なトランザクションの1つです。`inputs`と`outputs`のトランザクションフィールドは、通常このトランザクションにおいて重要です(例えば、NEOをどれだけ送信するか、どのアドレスに送信するかを管理します)。

   + PublishTransaction

      > [!警告]
      スマートコントラクトのため、無効化され、Neo.Contract.Createに置き換えられました。

      [Alternative .NET Smart Contract Framework](../sc/fw/dotnet/neo/Contract/Create.md)を参照してください。

      [Alternative Smart Contract API](../sc/api/neo.md)を参照してください。

   + Invoking a Transaction

      | サイズ | フィールド | データの型 | 説明 |
      | ---- | ------ | ------- | --------------- |
      | -    | -      | -       | トランザクションのためのパブリックフィールド |
      | ?    | Script | uint8[] | スマートコントラクトのスクリプトにより呼び出される |
      | 8    | Gas    | int64   | スマートコントラクトを実行するのに必要なコスト |
      | -    | -      | -       | トランザクションのためのパブリックフィールド |

1. トランザクションの属性

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |1|Usage|uint8|使用方法|
   |0\|1|length|uint8|データ長(場合によっては省略される)|
   |length|Data|uint8[length]|拡張データ|

   トランザクションは、拡張用途のためのデータを含む場合があり、これらのデータはトランザクションの属性フィールドに格納されます。

   各トランザクション属性の用途は異なります:

   |値|名前|説明|
   |---|---|---|
   |0x00|ContractHash|コントラクトのハッシュ|
   |0x02-0x03|ECDH02-ECDH03|ECDH鍵交換のためのパブリックキー|
   |0x20|Script|トランザクションの追加のバリデーション|
   |0x30|Vote|投票に使用する|
   |0x80|CertUrl|証明書のURLアドレス|
   |0x81|DescriptionUrl|説明のURLアドレス|
   |0x90|Description|簡単な説明|
   |0xa1-0xaf|Hash1-Hash15|カスタムハッシュ値を保管するのに使用|
   |0xf0-0xff|Remark-Remark15|注意事項|

   ContractHash、一連のECDH、一連のHashに関するデータ長は32バイト固定で、データ長（length）フィールドは省略されます。

   CertUrl、DescriptionUrl、Description、一連のRemarkに関するデータ長は明確に定義することが必要で、長さは255を超えてはなりません。

1. トランザクションのInput

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |32|PrevHash|uint256|前のトランザクションのハッシュ|
   |2|PrevIndex|uint16|前のトランザクションのインデックス|

1. トランザクションのOutput

   |サイズ|フィールド|データ型|説明|
   |---|---|---|---|
   |32|AssetId|uint256|アセットID|
   |8|Value|int64|値|
   |20|ScriptHash|uint160|受領者のアドレス|
   
   各トランザクションは最大65536のOutputを持ち得ます。

1. 検証スクリプト

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |?|StackScript|uint8[]|スタックスクリプトコード|
   |?|RedeemScript|uint8[]|コントラクトスクリプトコード|

   スタックスクリプトはPUSH操作のみに使用でき、それは署名のようなデータをスタックにプッシュするのに使用します。スクリプトのインタプリタはまずスタックコードを実行してから、コントラクトスクリプトコードを実行します。

   トランザクションにおいて、コントラクトスクリプトコードのハッシュ値はバリデーションの一部であるトラザクションのOutputと一貫していなければなりません。後のセクションでは、スクリプトの実行プロセスについて詳しく説明します。

ネットワークメッセージ
-------

すべてのネットワークメッセージはこの構造で送信されます:

|サイズ|フィールド|データの型|説明|
|---|---|---|---|
|4|Magic|uint32|プロトコルID|
|12|Command|char[12]|コマンド|
|4|length|uint32|ペイロード長|
|4|Checksum|uint32|チェックサム|
|length|Payload|uint8[length]|メッセージの内容|
 
定義されているMagic値:

|値|説明|
|---|---|
|0x00746e41|プロダクションモード|
|0x74746e41|テストモード|

コマンドは長さは12バイトのutf8コードで、余分な部分は0で埋められます。

Checksumは、SHA256ハッシュを2度適用したPayloadの、最初の4バイトです。

異なるオーダーに従って、ペイロードは異なる詳細なフォーマットを持ちます。下記を参照してください。

1. version

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |4|Version|uint32|プロトコルのバージョン、現在は0|
   |8|Services|uint64|ノードにより提供されるサービスは現在1です|
   |4|Timestamp|uint32|現在時刻|
   |2|Port|uint16|サーバがListenしているポートで、使用しない場合は0|
   |4|Nonce|uint32|ノードをパブリックIPと区別するために使用します|
   |?|UserAgent|varstr|クライアントID|
   |4|StartHeight|uint32|ブロックチェーンの高さ|
   |1|Relay|bool|受信するか転送するか|
 

   ノードが接続要求を受信すると、ノードは直ちにそのバージョンを宣言します。 両者が互いのバージョンを取得するまで、他の通信は起こりません。

1. verack

   ノードがバージョンメッセージを受信する場合、即座にverackで返信します。

   このメッセージはペイロードを持ちません。
 
1. getaddr

   接続数を増やすため、ノードに対し、新たなアクティブノードのバッチを要求します。

   このメッセージはペイロードを持ちません。
 
1. addr

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |30*?|AddressList|net_addr[]|ネットワーク上の他のノードのアドレス|

   getaddrメッセージの受信後、ノードはaddrメッセージを返送し、ネットワーク上で既に知られたノードの情報を提供します。
 
1. getheaders

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |32*?|HashStart|uint256[]|ノードが要求した最新のブロックのハッシュ|
   |32|HashStop|uint256|ノードが要求した最後のブロックのハッシュ|
   
   HashStartからHashStopまでを含む最大で2000ブロックのヘッダーパッケージをノードに要求します。その後にブロックハッシュを取得するため、getheadersメッセージを再送する必要があります。このメッセージは、トランザクションを含まないブロックチェーンをすばやくダウンロードするために使用します。
 
1. headers

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |?*?|Headers|header[]|ブロックのヘッド|

   getheadersメッセージを受信した後は、ノードはヘッダーメッセージを返送し、ネットワーク上で知られたノードに関する情報を提供します。
 
1. getblocks

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |32*?|HashStart|uint256[]|ノードが要求した最新のブロックのハッシュ|
   |32|HashStop|uint256|ノードが要求した最後のブロックのハッシュ|

   HashStartからHashStopまでのinvメッセージをノードに要求します。HashStartからHashStopまでのブロック数は最大500です。それ以上のブロックハッシュを取得したい場合、getblocksメッセージを再送する必要があります。
 
1. inv

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |36*?|Inventories|inv_vect[]|インベントリのデータ|

   ノードはこのメッセージによって、所有するオブジェクト情報をブロードキャストできます。メッセージは自動的に送信することも、getblocksメッセージに応答するのに使うこともできます。

   オブジェクト情報は次のリストに含まれています:

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |4|Type|uint32|オブジェクトの型|
   |32|Hash|uint256|オブジェクトのハッシュ|
 
   オブジェクトの型:

   |値|名前|説明|
   |---|---|---|
   |0x01|TX|トランザクション|
   |0x02|Block|ブロック|
   |0xe0|Consensus|コンセンサスデータ|
 
1. getdata

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |36*?|Inventories|inv_vect[]|インベントリのデータ|

   ノードから特定のオブジェクトを要求するには: このメッセージは通常、invパケットを受信して既知の要素が削除された後に送信されます。
 
1. block

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |?|Block|block|ブロック|

   ノードにブロックを送信し、getdataメッセージに応答します。
 
1. tx

   |サイズ|フィールド|データの型|説明|
   |---|---|---|---|
   |?|Transaction|tx|トランザクション|

   ノードにトランザクションを送信し、getdataメッセージに応答します。

   |サイズ|フィールド|データの型|説明|
   |----|---------|--------- |----------------- |
   |32 *?|HashStart|uint256[]|ノードは最新のブロックハッシュとして知られます|
   |32|hashStop|uint256|最後のブロックを要求する|
